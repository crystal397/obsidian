- # 쿠버네티스(Kubernetes)
	- 쿠버네티스(Kubernetes, K8s)는 컨테이너화된 애플리케이션의 자동 디플로이, 스케일링 등을 제공하는 관리 시스템으로 오픈 소스 기반이다.
	- 원래 구글에 의해 설계되었고 현재 리눅스 재단에 의해 관리되고 있다.
	- ## 쿠버네티스의 장단점
		- ### 장점
			- 자동 배포
			- 모니터링
			- 자동복구
		- ### 단점
			- 시스템 자원 소모
			- 높은 학습 난이도
			- 높은 진입 장벽
	- ## 쿠버네티스 구조
		![](https://i.imgur.com/ZWdlxm3.png)
- # 쿠버네티스 설치
	- ## 쿠버네티스 마스터 노드 설정
		```
		sudo -i
		modprobe br_netfilter
		```
		- **modprode**: 리눅스 커널 모듈 관리 도구, 특정 모듈을 로드하거나 제거 가능
		- 브릿지 네트워크 인터페이스에 대한 트래픽이 iptables 규칙에 의해 처리되도록 함
		```
		sysctl net.bridge.bridge-nf-call-iptables=1
		```
		- **br_netfilter**: 네트워크 패킷 처리 관련 커널 모듈, iptables/netfilter 규칙 적용되게함.
			즉, 컨테이너와 호스트 간의 인터페이스 등에서 발생하는 트래픽에 대해 규칙을 적용해 트래픽을 관리한다는 뜻
		- 커널이 처리하는 패킷을 외부로 포워딩(IP forwarding)기능
		```
		vim /etc/sysctl.conf
		# 마지막에 두줄 추가
		net.bridge.bridge-nf-call-iptables=1
		net.ipv4.ip_forward=1
		```
		
		![](https://i.imgur.com/9JPEWNy.png)
		- Swap 에 0으로 나와야함!!
		- **swap이 활성화 되어있는 경우**
			![](https://i.imgur.com/sMuPrxx.png)
			```
			sudo -i
			swapoff --all
			free -h
			cat /proc/swaps
			vim /etc/fstab
			shutdown -r now
			```
	- ## container 적용
		```
		sudo mkdir -p /etc/containerd
		containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
		```
		- containerd config default : containerd의 기본 설정 출력
		- tee : 입력 받은 데이터를 파일에 쓰면서 동시에 표준 출력으로 내보냄
		- > /dev/null : 화면에 출력하는 내용을 버리기 위해 사용
		```
		sudo vim /etc/containerd/config.toml
		/SystemdCgroup    # 검색
		SystemdCgroup = false -> true 로 변경
		
		sudo systemctl restart containerd
		sudo systemctl enable containerd
		sudo systemctl status containerd
		```
	- ## 쿠버네티스 설치(모든 노드에 설치)
		```
		sudo apt-get update
		
		sudo apt-get install -y apt-transport-https ca-certificates curl
		
		# 아래는 공식 홈페이지와 다름 !!주의!!
		sudo mkdir -p /etc/apt/keyrings
		
		sudo curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
		
		echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
		
		sudo apt-get update
		
		sudo apt-get install -y kubelet kubeadm kubectl
		
		sudo apt-mark hold kubelet kubeadm kubectl
		```
	- ## 쿠버네티스 설치 확인
		```
		sudo -i
		kubelet --version
		kubeadm version
		kubectl version --output=yaml
		```
		- ### 인증서 상태 확인
		```
		kubeadm certs check-expiration
		```
		- ### kubeadm이 사용할 수 있는 이미지 출력
		```
		kubeadm config images list
		```
	- ## 마스터 노드 설정
		```
		kubeadm config images pull --cri-socket /run/containerd/containerd.sock
		
		kubeadm init --apiserver-advertise-address=인스턴스 프라이빗IP --pod-network-cidr=192.168.0.0/16 --cri-socket /run/containerd/containerd.sock
		```
		- calico: 192.168.0.0/16 <-현업에서 주로 사용
		- flannel: 10.244.0.0/16 <- 간단할때 사용함
		```
		kubeadm certs check-expiration
		exit
		```
	- ## 쿠버네티스 설치
		```
		# root계정 말고 user계정으로도 사용 가능 하도록 설정
		mkdir -p $HOME/.kube
		sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
		sudo chown $(id -u):$(id -g) $HOME/.kube/config
		```
	- ### calico 설치
		- https://docs.tigera.io/calico/latest/getting-started/kubernetes/self-managed-onprem/onpremises
		```
		mkdir app
		cd app
		
		kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml
		
		curl https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/custom-resources.yaml -O
		```
		![](https://i.imgur.com/CEVrCRi.png)
		```
		kubectl create -f custom-resources.yaml
		
		watch kubectl get pods -n calico-system
		# STATUS Running 확인 (약 1분정도 기다려야 Running 상태가 된다.)
		```
		- #### 참고) 쿠버네티스 cni설치(2) - flannel
			```
			kuberctl apply -f https://github.com/flannel/releases/latest/download/kube-flannel.yml
			```
			- ##### (2)이 안된다면
				```
				wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
				kubectl apply -f kube-flannel.yml
				```
		- ### 마스터노드에도 파드 생성하도록 설정
			```
			kubectl get node
			kubectl describe node 노드이름 | grep Taints
			
			# Taints 안만든다 -> untainted로 변경
			kubectl taint nodes --all node-role.kubernetes.io/control-plane-
			```
	- ## 마스터 노드의 설정 가지고 오기
		```
		mkdir -p $HOME/.kube
		scp -p 마스터노드유저@마스터노드IP:~/.kube/config ~/.kube/config
		
		sudo -i
		```
	- ## hello world!
		```
		kubectl run hello-world --image=hello-world --restart=Never
		kubectl get pod
		ubectl get pod -o wide
		```
		- IP는 pod의 IP
	- ## 로그 확인하기
		```
		kubectl get pod
		kubectl logs {pod NAME}
		```
	- 쿠버네티스 기초
	- 디플로이먼트 : 파드 안에 컨테이너 파드가 여러개 일수 있음 파드 여러개를 묶는것을 말한다.
		- 레플리카셋 : 디플로이먼트 안의 파드를 관리하는것
	- 서비스 : 디플로이먼트가 EC2에서 유저에게 보내는것
	- 스토리지볼륨 : 도커볼륨 과 같은 역할
	- 스테이트풀셋 : 순서가 있는 컨테이너
	- 인그레스 : 서비스가 여러개 일때 인그레스를 통해서 나간다
	- 잡, 크론잡 : 배치작업 할때, 크론탭과 같은 역할
		```
		# 클러스터 정보
		kubectl cluster-info
		
		# 노드 정보
		kubectl get node
		
		# 파드 정보
		kubectl get pod
		```
	- ## pod 삭제
		```
		kubectl delete pod {pod NAME}
		```
	- ## 매니페스트(Manifest)의 개념
		- 매니페스트란 쿠버네티스 오브젝트를 생성하기 위한 메타정보를 YAML로 기술한 파일
	- ## 매니패스트 작성
		```
		~/work/k8s/basic$ vim nginx-test01.yml
		```
		![400](https://i.imgur.com/VX3HP7f.png) _들여쓰기, 대소문자 주의!!_
	- ## $ kubectl apply -f {파일 이름}
		- apply 명령어는 쿠버네티스 리소스를 정의하는 파일을 통해 애플리케이션을 관리
		- kubectl apply 명령어를 통해 쿠버네티스 리소스를 생성하거나 업데이트 할 수 있다
		```
		kubectl apply -f nginx-test01.yml
		kubectl get pod
		# STATUS Running 확인
		```
		- 삭제
			```
			kubectl delete -f {파일 이름}
			```
			